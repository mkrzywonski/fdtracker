{% extends 'base.html' %}

{% block content %}
<div class="form-title text-center">Add New Batch</div>
<form method="POST">
    {% if error_messages %}
    <div class="alert alert-danger">
        <ul>
            {% for error in error_messages %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="mb-3 row align-items-center">
        <label class="form-label col-sm-4 col-form-label text-end text-nowrap">Number of Trays</label>
        <div class="col-sm-2">
            <select name="tray_count" class="form-control w-auto" id="trayCount">
                <option value="" disabled selected>Select...</option>
                {% for i in range(1, 8) %}
                <option value="{{ i }}" {% if tray_count and i==tray_count %}selected{% endif %}>
                    {{ i }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div id="trayContainer" data-trays="{{ trays | tojson | safe }}">
        {% for i in range(tray_count) %}
        <div class="card border border-dark mb-3">
            <div class="card-header mb-2 bg-dark text-white">Tray {{ i + 1 }}
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Contents</label>
                    <input type="text" name="contents_{{ i }}" class="form-control"
                        value="{{ trays[i]['contents'] if trays|length > i else '' }}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Initial Weight (g)</label>
                    <input type="number" step="0.01" name="starting_weight_{{ i }}" class="form-control"
                        value="{{ trays[i]['starting_weight'] if trays|length > i else '' }}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tray Notes</label>
                    <textarea name="notes_{{ i }}" class="form-control"
                        rows="2">{{ trays[i]['notes'] if trays|length > i else '' }}</textarea>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card border border-dark mb-3">
        <div class="card-header mb-2 bg-dark text-white">Batch Notes</div>
        <div class="card-body">
            <textarea name="batch_notes" class="form-control"
                rows="3">{{ batch_notes if batch_notes else '' }}</textarea>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Start Batch</button>
    <a href="{{ url_for('view_batches') }}" class="btn btn-secondary">Cancel</a>
</form>

<script>
    // Initialize savedTrays array once at the top level
    let savedTrays = [];

    document.getElementById('trayCount').addEventListener('change', function () {
        const container = document.getElementById('trayContainer');
        const count = parseInt(this.value);

        // Save current values before regenerating
        const existingTrays = container.querySelectorAll('.card');
        existingTrays.forEach((tray, index) => {
            savedTrays[index] = {
                contents: tray.querySelector('[name^="contents_"]').value,
                starting_weight: tray.querySelector('[name^="starting_weight_"]').value,
                notes: tray.querySelector('[name^="notes_"]').value
            };
        });

        container.innerHTML = '';

        for (let i = 0; i < count; i++) {
            // Use saved data if available, otherwise empty strings
            const tray = savedTrays[i] || { contents: '', starting_weight: '', notes: '' };

            container.innerHTML += `
            <div class="card border border-primary mb-3">
                <div class="card-body">
                    <h2 class="card-title">Tray ${i + 1}</h2>
                    <div class="mb-3">
                        <label class="form-label">Contents</label>
                        <input type="text" name="contents_${i}" class="form-control" value="${tray.contents}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Weight (g)</label>
                        <input type="number" step="0.01" name="starting_weight_${i}" class="form-control" value="${tray.starting_weight}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes_${i}" class="form-control" rows="2">${tray.notes}</textarea>
                    </div>
                </div>
            </div>
        `;
        }
    });

    // Trigger the script when the page loads, preserving server-rendered data
    document.getElementById('trayCount').dispatchEvent(new Event('change'));
</script>
{% endblock %}